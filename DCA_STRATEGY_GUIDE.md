# 일일 DCA + 회차별 익절 + 트레일링 매수 + 포지션 스케일링 전략 가이드

레버리지 ETF의 높은 변동성을 활용하여 안정적인 수익을 추구하는 스마트 DCA 전략입니다.

---

## 📋 목차

1. [전략 개요](#-전략-개요)
2. [핵심 특징](#-핵심-특징)
3. [작동 원리](#-작동-원리)
4. [파라미터 가이드](#-파라미터-가이드)
5. [사용 방법](#-사용-방법)
6. [백테스트 실행](#-백테스트-실행)
7. [실전 운용 팁](#-실전-운용-팁)
8. [성과 분석](#-성과-분석)
9. [주의사항](#️-주의사항)

---

## 🎯 전략 개요

**DailyDCAStrategy**는 전통적인 DCA(Dollar Cost Averaging, 정액 분할 매수)의 장점을 유지하면서, 레버리지 ETF의 높은 변동성에 최적화된 4가지 핵심 기능을 결합한 전략입니다.

### 전략의 4대 핵심 기능

1. **일일 DCA (Daily Dollar Cost Averaging)**
   - 매일 가격을 체크하여 조건 충족 시 자동 매수
   - 시간 분산 투자로 리스크 감소

2. **회차별 익절 (Round-based Profit Taking)**
   - 각 매수 회차를 개별 추적
   - 수익난 회차만 선별적으로 매도
   - 손실 회차는 보유하여 회복 대기

3. **트레일링 매수 (Trailing Buy)**
   - 최근 고점 대비 하락률 추적
   - 상승장에서도 조정 구간마다 자동 진입
   - 놓친 기회 최소화

4. **포지션 스케일링 (Position Scaling)**
   - 평균 매수가 대비 하락 깊이 측정
   - 하락폭이 클수록 매수 수량 자동 증가
   - 평균 단가를 빠르게 낮춤

---

## ⭐ 핵심 특징

### 왜 이 전략이 특별한가?

#### 1. 똑똑한 매수 조건 (2가지 조건 OR)

```
매수 조건 (둘 중 하나만 만족하면 매수):
├─ 조건 1: 전일 종가보다 낮을 때
└─ 조건 2: 최근 N일 최고가 대비 M% 이상 하락했을 때
```

**기존 DCA의 문제점**
- 고정된 시간 간격으로만 매수 (예: 매주 월요일)
- 가격과 무관하게 기계적으로 매수
- 좋은 매수 기회를 놓치는 경우 많음

**이 전략의 해결책**
- 가격 기반 동적 매수
- 하락 시마다 자동 매수 → 더 많은 기회 포착
- 상승장에서도 조정 구간 활용

#### 2. 평균 매수가 기준 포지션 스케일링

```
예시: depth_threshold=5.0, base_quantity=1

1일차: $100에 1주 매수
       └─ 평균 매수가: $100

2일차: $95 (-5.0%)
       └─ 평균가 대비 5% 하락 → 2주 매수
       └─ 새 평균 매수가: $96.67 (=$290 / 3주)

3일차: $90 (-6.9%)
       └─ 평균가($96.67) 대비 6.9% 하락 → 2주 매수
       └─ 새 평균 매수가: $93.75 (=$475 / 5주)

4일차: $97 (+3.5%)
       └─ 3% 이상 수익난 회차 매도:
           - 1일차 매수분: $100 → $97 (-3%) → 보유
           - 2일차 매수분: $95 → $97 (+2.1%) → 보유
           - 3일차 매수분: $90 → $97 (+7.8%) → 매도! ✅
```

**기존 DCA vs 포지션 스케일링**

| 상황 | 기존 DCA | 포지션 스케일링 |
|------|----------|-----------------|
| 매수가 $100 | 1주 매수 | 1주 매수 |
| 5% 하락 → $95 | 1주 매수 | 2주 매수 (2배) |
| 10% 하락 → $90 | 1주 매수 | 3주 매수 (3배) |
| 15% 하락 → $85 | 1주 매수 | 4주 매수 (4배) |
| **평균 단가** | **$92.50** | **$90.00** |
| **회복 필요 상승률** | **8.1%** | **4.4%** |

→ **포지션 스케일링은 평균 단가를 빠르게 낮춰 손익분기점 도달 시간을 단축합니다!**

#### 3. 회차별 개별 익절의 위력

**일반적인 전체 익절**
```
상황: 3회 매수 후 가격 상승
├─ 1회차: $100 → $103 (+3%)
├─ 2회차: $98 → $103 (+5.1%)
└─ 3회차: $96 → $103 (+7.3%)

평균 매수가: $98
현재 수익률: +5.1%

→ 전체 매도? 아직 목표 수익률(10%) 미달 → 보유
→ 결과: 가격 다시 하락 → 수익 기회 상실
```

**회차별 개별 익절**
```
상황: 동일
├─ 1회차: $100 → $103 (+3%) → 익절 ✅
├─ 2회차: $98 → $103 (+5.1%) → 익절 ✅
└─ 3회차: $96 → $103 (+7.3%) → 익절 ✅

→ 모든 회차가 수익! → 전부 매도
→ 결과: 확실한 수익 실현, 리스크 제거
```

#### 4. 트레일링 매수로 상승장 대응

**문제: 상승장에서 매수 기회 부족**
```
전통적 DCA:
Day 1: $100 → 매수
Day 2: $102 (전일 대비 +2%) → 매수 안함
Day 3: $105 (전일 대비 +2.9%) → 매수 안함
Day 4: $107 (전일 대비 +1.9%) → 매수 안함
...
→ 계속 상승만 하면 매수 기회 없음
```

**트레일링 매수 해결책**
```
DailyDCAStrategy (lookback_days=7, pullback_percent=3.0):
Day 1: $100 → 매수
Day 2: $102 → 매수 안함 (상승)
Day 3: $105 → 매수 안함 (상승, 최근 고점 갱신)
Day 4: $107 → 매수 안함 (상승, 최근 고점 갱신)
Day 5: $104 → 매수! (최근 고점 $107 대비 -2.8%)
                     ↑
              상승장 중 조정 구간에서 자동 진입!
```

---

## 🔧 작동 원리

### 전체 흐름도

```
매일 시장 종가 체크
       ↓
┌──────────────────────┐
│ 매수 조건 확인        │
└──────────────────────┘
       ↓
┌──────────────────────────────────┐
│ 조건 1: 전일 종가 대비 하락?      │
│ 조건 2: 최근 고점 대비 N% 하락?   │
└──────────────────────────────────┘
       ↓
    매수 시
       ↓
┌──────────────────────────────────┐
│ 포지션 스케일링 계산              │
│ - 평균 매수가 대비 하락률 계산    │
│ - 하락 깊이에 따라 수량 결정      │
│   (5% → 1주, 10% → 2주, ...)     │
└──────────────────────────────────┘
       ↓
    매수 실행
       ↓
┌──────────────────────────────────┐
│ 회차별 포지션 기록                │
│ - 매수가: $XX.XX                 │
│ - 수량: N주                      │
└──────────────────────────────────┘
       ↓
    익절 조건 확인
       ↓
┌──────────────────────────────────┐
│ 각 회차별 수익률 계산              │
│ - 회차 1: +5% → 매도 ✅          │
│ - 회차 2: +2% → 보유             │
│ - 회차 3: -1% → 보유             │
└──────────────────────────────────┘
```

### 상세 동작 예시

```python
# 시나리오: TQQQ 10일간 거래
# 설정: max_positions=10, profit_target=3%,
#       position_scaling=True, depth_threshold=5%

Day 1: $50.00 (첫날)
  └─ 첫날 무조건 매수: 1주 @ $50.00
  └─ 포지션: [($50, 1주)]

Day 2: $49.00 (전일 대비 -2%)
  └─ 매수 조건 충족: 전일보다 하락
  └─ 평균가($50) 대비 -2% → 수량: 1주
  └─ 매수: 1주 @ $49.00
  └─ 포지션: [($50, 1주), ($49, 1주)]
  └─ 평균 매수가: $49.50

Day 3: $47.00 (전일 대비 -4.1%)
  └─ 매수 조건 충족: 전일보다 하락
  └─ 평균가($49.50) 대비 -5.05% → 수량: 2주 (스케일링!)
  └─ 매수: 2주 @ $47.00
  └─ 포지션: [($50, 1주), ($49, 1주), ($47, 2주)]
  └─ 평균 매수가: $48.00

Day 4: $46.00 (전일 대비 -2.1%)
  └─ 매수 조건 충족: 전일보다 하락
  └─ 평균가($48.00) 대비 -4.17% → 수량: 1주
  └─ 매수: 1주 @ $46.00
  └─ 포지션: [($50, 1주), ($49, 1주), ($47, 2주), ($46, 1주)]
  └─ 평균 매수가: $47.60

Day 5: $48.50 (전일 대비 +5.4%)
  └─ 상승! 회차별 익절 체크:
      - Day 1: $50 → $48.50 (-3%) → 보유
      - Day 2: $49 → $48.50 (-1%) → 보유
      - Day 3: $47 → $48.50 (+3.2%) → 매도! ✅ (2주)
      - Day 4: $46 → $48.50 (+5.4%) → 매도! ✅ (1주)
  └─ 3주 매도 완료
  └─ 포지션: [($50, 1주), ($49, 1주)]
  └─ 평균 매수가: $49.50 (남은 포지션 기준)

Day 6: $47.50 (전일 대비 -2.1%)
  └─ 매수 조건 충족: 전일보다 하락
  └─ 평균가($49.50) 대비 -4.04% → 수량: 1주
  └─ 매수: 1주 @ $47.50
  └─ 포지션: [($50, 1주), ($49, 1주), ($47.50, 1주)]

Day 7: $51.00 (전일 대비 +7.4%)
  └─ 상승! 회차별 익절 체크:
      - $50 → $51 (+2%) → 보유
      - $49 → $51 (+4.1%) → 매도! ✅ (1주)
      - $47.50 → $51 (+7.4%) → 매도! ✅ (1주)
  └─ 2주 매도 완료
  └─ 포지션: [($50, 1주)]

Day 8-10: ... (계속)
```

---

## 📊 파라미터 가이드

### 필수 파라미터

#### `max_positions` (최대 매수 회차)
- **기본값**: 10
- **설명**: 동시에 보유할 수 있는 최대 매수 회차 수
- **선택 가이드**:
  | 값 | 특성 | 추천 대상 |
  |-----|------|-----------|
  | 5회 | 보수적, 빠른 회전 | 소액 투자자 ($1,000 미만) |
  | 10회 | 균형잡힌 설정 | **대부분의 투자자 추천** |
  | 15회 | 공격적, 충분한 자금 필요 | 중액 투자자 ($10,000 이상) |
  | 20회+ | 매우 공격적 | 고액 투자자 ($50,000 이상) |

#### `profit_target_percent` (익절 목표 수익률)
- **기본값**: 3.0 (3%)
- **설명**: 각 회차별 익절 기준 수익률
- **선택 가이드**:
  | 값 | 특성 | 시장 환경 |
  |-----|------|-----------|
  | 1~2% | 빠른 회전, 높은 승률 | 고변동성 장세 |
  | 3~5% | 균형잡힌 설정 | **일반적인 시장** |
  | 6~10% | 느린 회전, 큰 수익 | 저변동성 장세 |

### 포지션 스케일링 파라미터

#### `position_scaling` (스케일링 활성화 여부)
- **기본값**: True
- **설명**: 하락 깊이에 따른 수량 증가 기능 ON/OFF
- **True**: 하락 깊이에 따라 수량 자동 증가 (추천)
- **False**: 항상 고정 수량으로 매수

#### `base_quantity` (기본 매수 수량)
- **기본값**: 1
- **설명**: 기본 매수 수량 (스케일링의 기준)
- **예시**:
  - base_quantity=1: 1주, 2주, 3주, 4주...
  - base_quantity=10: 10주, 20주, 30주, 40주...

#### `depth_threshold` (수량 증가 기준 하락률)
- **기본값**: 5.0 (5%)
- **설명**: 평균 매수가 대비 몇 % 하락마다 수량을 1배 증가시킬지 결정
- **선택 가이드**:
  | 값 | 스케일링 속도 | 자금 소모 | 추천 성향 |
  |-----|---------------|-----------|-----------|
  | 3% | 빠름 (공격적) | 높음 | 공격적 투자자 |
  | 5% | 중간 (균형) | 중간 | **일반 투자자** |
  | 10% | 느림 (보수적) | 낮음 | 보수적 투자자 |

#### `max_quantity_multiplier` (최대 수량 배수)
- **기본값**: 5
- **설명**: 최대 몇 배까지 수량을 늘릴 수 있는지 제한
- **예시**: base_quantity=1, max=5 → 최대 5주까지만 매수

**수량 계산 공식**:
```python
평균_매수가_대비_하락률 = (평균_매수가 - 현재가) / 평균_매수가 * 100
배수 = 1 + int(평균_매수가_대비_하락률 / depth_threshold)
실제_배수 = min(배수, max_quantity_multiplier)
매수_수량 = base_quantity * 실제_배수
```

**계산 예시**:
```
설정: base_quantity=1, depth_threshold=5%, max_multiplier=5

평균가: $100
현재가: $100 → 하락률 0% → 배수 1 → 수량 1주
현재가: $95  → 하락률 5% → 배수 2 → 수량 2주
현재가: $90  → 하락률 10% → 배수 3 → 수량 3주
현재가: $85  → 하락률 15% → 배수 4 → 수량 4주
현재가: $80  → 하락률 20% → 배수 5 → 수량 5주 (최대)
현재가: $75  → 하락률 25% → 배수 6 → 수량 5주 (제한)
```

### 트레일링 매수 파라미터

#### `lookback_days` (고점 추적 기간)
- **기본값**: 7
- **설명**: 최근 몇 일간의 최고가를 추적할지 결정
- **선택 가이드**:
  | 값 | 특성 | 시장 환경 |
  |-----|------|-----------|
  | 3~5일 | 단기 고점, 빈번한 진입 | 고변동성 단기 트레이딩 |
  | 7~10일 | 중기 고점, 균형잡힌 진입 | **일반적인 시장** |
  | 14~30일 | 장기 고점, 선별적 진입 | 추세 중심 투자 |

#### `pullback_percent` (고점 대비 매수 기준 하락률)
- **기본값**: 3.0 (3%)
- **설명**: 최근 고점 대비 몇 % 하락 시 매수할지 결정
- **선택 가이드**:
  | 값 | 진입 빈도 | 시장 환경 |
  |-----|-----------|-----------|
  | 2% | 높음 (공격적) | 변동성 큰 시장 |
  | 3~5% | 중간 (균형) | **일반적인 시장** |
  | 7~10% | 낮음 (보수적) | 안정적인 시장 |

### 기타 파라미터

#### `first_day_buy` (첫날 매수 여부)
- **기본값**: True
- **설명**: 백테스트 또는 전략 시작 첫날에 무조건 매수할지 여부
- **True**: 첫날 무조건 1회 매수 (포지션 형성)
- **False**: 첫날도 조건 충족 시에만 매수

---

## 💻 사용 방법

### 기본 사용법

```python
from src.data.data_fetcher import DataFetcher
from src.strategies.percentage_strategy import DailyDCAStrategy
from src.backtesting.backtester import Backtester

# 1. 데이터 수집
fetcher = DataFetcher()
data = fetcher.fetch_data('TQQQ', period='1y')

# 2. 전략 설정
strategy = DailyDCAStrategy(
    max_positions=10,
    profit_target_percent=3.0,
    lookback_days=7,
    pullback_percent=3.0,
    position_scaling=True,
    base_quantity=1,
    depth_threshold=5.0,
    max_quantity_multiplier=5
)

# 3. 백테스트 실행
backtester = Backtester(initial_capital=10000)
results = backtester.run(strategy, data)

# 4. 결과 출력
backtester.print_summary()
```

### 추천 프리셋 설정

#### 🟢 균형잡힌 설정 (추천)

```python
strategy = DailyDCAStrategy(
    max_positions=10,              # 적당한 회차
    profit_target_percent=3.0,     # 3% 익절
    first_day_buy=True,
    lookback_days=7,               # 일주일 고점 추적
    pullback_percent=3.0,          # 3% 조정 시 진입
    position_scaling=True,
    base_quantity=1,
    depth_threshold=5.0,           # 5%마다 수량 증가
    max_quantity_multiplier=5      # 최대 5배
)
```

**적합한 투자자**: 대부분의 일반 투자자
**자금 규모**: $5,000 ~ $20,000
**특징**: 안정적인 수익 추구, 중간 정도 리스크

#### 🔴 공격적 설정

```python
strategy = DailyDCAStrategy(
    max_positions=15,              # 많은 회차
    profit_target_percent=2.0,     # 2% 빠른 익절
    first_day_buy=True,
    lookback_days=5,               # 단기 고점
    pullback_percent=2.0,          # 2% 작은 조정에도 진입
    position_scaling=True,
    base_quantity=1,
    depth_threshold=3.0,           # 3%마다 빠르게 수량 증가
    max_quantity_multiplier=10     # 최대 10배
)
```

**적합한 투자자**: 고위험 고수익 추구, 경험 많은 투자자
**자금 규모**: $20,000 이상
**특징**: 빠른 회전율, 높은 자금 활용도, 큰 변동성

#### 🔵 보수적 설정

```python
strategy = DailyDCAStrategy(
    max_positions=8,               # 적은 회차
    profit_target_percent=5.0,     # 5% 여유있는 익절
    first_day_buy=True,
    lookback_days=10,              # 장기 고점
    pullback_percent=5.0,          # 5% 충분한 조정 후 진입
    position_scaling=True,
    base_quantity=1,
    depth_threshold=10.0,          # 10%마다 느리게 수량 증가
    max_quantity_multiplier=3      # 최대 3배
)
```

**적합한 투자자**: 안정성 중시, 초보 투자자
**자금 규모**: $1,000 ~ $10,000
**특징**: 낮은 리스크, 안정적인 수익, 느린 회전율

#### ⚪ 스케일링 OFF (고정 수량)

```python
strategy = DailyDCAStrategy(
    max_positions=10,
    profit_target_percent=3.0,
    first_day_buy=True,
    lookback_days=7,
    pullback_percent=3.0,
    position_scaling=False,        # 스케일링 비활성화
    base_quantity=1                # 항상 1주씩만
)
```

**적합한 투자자**: 전통적 DCA 선호, 단순함을 추구
**특징**: 예측 가능한 자금 소모, 간단한 관리

---

## 🧪 백테스트 실행

### 기본 백테스트

전략의 과거 성과를 시뮬레이션하여 검증합니다.

```bash
cd examples
python daily_accumulation_test.py
```

**출력 예시**:
```
================================================================================
[ 일일 DCA + 회차별 익절 전략 ]
================================================================================

전략 설명:
  1. 매일 종가 체크
  2. 첫날 무조건 1회 매수
  3. 전일 종가보다 낮으면 추가 매수 (최대 10회)
  4. 전일 종가보다 높으면 각 회차별로 3% 이상 수익난 것만 매도
  5. ⭐ 평균 매수가 대비 하락 깊이에 따라 매수 수량 자동 증가

TQQQ 데이터 수집 중...
데이터 수집 완료: 252 일
기간: 2024-01-01 ~ 2024-12-31

백테스트 실행 중...

[ 백테스트 결과 ]
  초기 자본:         $10,000.00
  최종 자본:         $13,245.67
  총 수익:           $3,245.67
  수익률:            32.46%
  샤프 비율:         1.85
  최대 낙폭:         -12.34%
  승률:              68.5%

[ Buy & Hold 전략 대비 ]
  Buy & Hold 수익률:     25.30%
  전략 수익률:           32.46%
  초과 수익률:           +7.16%

[ 거래 통계 ]
  최대 보유 회차:   10회
  평균 보유 회차:   4.2회
  최대 보유 수량:   25주
  평균 보유 수량:   8.5주
  총 매수일:        145일
  총 매수 수량:     387주
  총 매도일:        98일
  평균 매수 수량:   2.7주/회
  최대 매수 수량:   5주/회
```

### 파라미터 비교 백테스트

여러 파라미터 조합을 비교하여 최적 설정을 찾습니다.

```python
# examples/daily_accumulation_test.py 에서 제공

test_configs = [
    {
        'scaling': False,
        'name': '스케일링 OFF (고정 1주)'
    },
    {
        'scaling': True,
        'depth_threshold': 10.0,
        'name': '스케일링 ON (보수적: 10%마다)'
    },
    {
        'scaling': True,
        'depth_threshold': 5.0,
        'name': '스케일링 ON (균형: 5%마다)'
    },
    {
        'scaling': True,
        'depth_threshold': 3.0,
        'name': '스케일링 ON (공격적: 3%마다)'
    }
]
```

**출력 예시**:
```
================================================================================
[ 파라미터 비교 ] 포지션 스케일링 ON/OFF
================================================================================

                          설정     수익률     샤프      낙폭     승률   총수량  평균  최대
----------------------------------------------------------------------------------------------------
       스케일링 OFF (고정 1주)     24.50%     1.45    -15.20%    65.0%    145주  1.0주  1주
스케일링 ON (보수적: 10%마다)     28.30%     1.62    -13.50%    66.5%    178주  1.2주  3주
  스케일링 ON (균형: 5%마다)     32.46%     1.85    -12.34%    68.5%    267주  1.8주  5주
스케일링 ON (공격적: 3%마다)     36.20%     1.95    -14.10%    70.2%    425주  2.9주  9주

💡 해석:
  - 스케일링 ON: 하락 깊이에 따라 매수 수량 자동 증가
  - 큰 하락에 더 많이 사서 평균 단가 빠르게 낮춤
  - 총수량/평균/최대 수량으로 공격성 확인 가능
```

### 커스텀 백테스트 작성

```python
# my_backtest.py

from src.data.data_fetcher import DataFetcher
from src.strategies.percentage_strategy import DailyDCAStrategy
from src.backtesting.backtester import Backtester

# 여러 ETF 비교
symbols = ['TQQQ', 'SOXL', 'UPRO']

for symbol in symbols:
    print(f"\n{'='*80}")
    print(f"테스트 중: {symbol}")
    print(f"{'='*80}")

    # 데이터 수집
    fetcher = DataFetcher()
    data = fetcher.fetch_data(symbol, period='1y')

    # 전략 실행
    strategy = DailyDCAStrategy(
        max_positions=10,
        profit_target_percent=3.0,
        position_scaling=True,
        depth_threshold=5.0
    )

    backtester = Backtester(initial_capital=10000)
    results = backtester.run(strategy, data)
    backtester.print_summary()
```

---

## 💡 실전 운용 팁

### 1. 자금 관리

#### 투입 자금 계산

**보수적 계산**:
```
필요 자금 = base_quantity × 종목 가격 × max_positions × 1.5

예시: TQQQ $50, base_quantity=1, max_positions=10
필요 자금 = 1 × $50 × 10 × 1.5 = $750
```

**공격적 계산 (스케일링 고려)**:
```
필요 자금 = base_quantity × 종목 가격 × max_positions × max_multiplier × 1.5

예시: TQQQ $50, base=1, max_pos=10, max_mult=5
필요 자금 = 1 × $50 × 10 × 5 × 1.5 = $3,750
```

#### 자금별 추천 설정

| 자금 규모 | base_quantity | max_positions | max_multiplier |
|-----------|---------------|---------------|----------------|
| $1,000 | 1주 | 5회 | 3배 |
| $5,000 | 1주 | 10회 | 5배 |
| $10,000 | 2주 | 10회 | 5배 |
| $20,000 | 3주 | 15회 | 5배 |
| $50,000+ | 5주 | 20회 | 10배 |

### 2. 시장 환경별 전략 조정

#### 횡보장 (박스권)
```python
# 빈번한 매매로 작은 수익 누적
strategy = DailyDCAStrategy(
    profit_target_percent=2.0,     # 작은 수익에도 익절
    pullback_percent=2.0,          # 작은 조정에도 매수
    depth_threshold=5.0            # 중간 속도 스케일링
)
```

#### 강한 상승장
```python
# 조정 구간 적극 활용
strategy = DailyDCAStrategy(
    profit_target_percent=5.0,     # 큰 수익 목표
    lookback_days=14,              # 장기 고점 추적
    pullback_percent=5.0,          # 충분한 조정 대기
    depth_threshold=10.0           # 느린 스케일링
)
```

#### 강한 하락장
```python
# 빠른 평균 단가 개선
strategy = DailyDCAStrategy(
    profit_target_percent=3.0,     # 표준 익절
    max_positions=15,              # 많은 회차 허용
    depth_threshold=3.0,           # 빠른 스케일링
    max_quantity_multiplier=10     # 큰 수량 증가
)
```

#### 변동성 장세
```python
# 균형잡힌 대응
strategy = DailyDCAStrategy(
    profit_target_percent=3.0,
    lookback_days=7,
    pullback_percent=3.0,
    depth_threshold=5.0,
    max_quantity_multiplier=5
)
```

### 3. 리스크 관리

#### 손절 규칙

전략 자체에는 손절이 없지만, 실전에서는 다음 규칙 권장:

```python
# 백테스트 결과 확인
metrics = backtester.calculate_metrics()
max_drawdown = metrics['Max Drawdown (%)']

# 실전 손절선: 백테스트 최대 낙폭의 1.5배
stop_loss = max_drawdown * 1.5

# 예: 백테스트 최대 낙폭 -15% → 실전 손절선 -22.5%
```

#### 포지션 리밸런싱

```python
# 분기별 또는 반기별 리밸런싱

# 1. 현재 수익 실현
if current_profit_pct > 20:
    # 모든 포지션 정리
    sell_all_positions()

# 2. 새로운 시작
strategy = DailyDCAStrategy(...)
restart_strategy()
```

#### 분산 투자

```python
# 여러 레버리지 ETF에 분산

portfolio = {
    'TQQQ': 0.4,  # 40% - 나스닥
    'SOXL': 0.3,  # 30% - 반도체
    'UPRO': 0.3   # 30% - S&P500
}

for symbol, weight in portfolio.items():
    allocated_capital = total_capital * weight

    backtester = Backtester(initial_capital=allocated_capital)
    # ... 전략 실행
```

### 4. 모니터링 체크리스트

**매일 체크**:
- [ ] 매수/매도 시그널 발생 여부
- [ ] 현재 보유 회차 수
- [ ] 평균 매수가 대비 현재 수익률

**주간 체크**:
- [ ] 총 수익률
- [ ] 이번 주 매수/매도 횟수
- [ ] 현금 잔고 확인

**월간 체크**:
- [ ] 월간 수익률 vs 목표 수익률
- [ ] 파라미터 조정 필요 여부
- [ ] 시장 환경 변화 분석

---

## 📈 성과 분석

### 주요 지표 해석

#### 수익률 지표

**Total Return (총 수익률)**
- 전략의 전체 수익률
- 목표: 20% 이상 (연간)

**Sharpe Ratio (샤프 비율)**
- 위험 대비 수익성
- 해석:
  - < 1.0: 낮음
  - 1.0 ~ 2.0: 좋음
  - \> 2.0: 매우 좋음

**Sortino Ratio (소르티노 비율)**
- 하방 위험 대비 수익성
- Sharpe보다 하락 리스크에 집중
- 해석: Sharpe Ratio와 동일

#### 리스크 지표

**Max Drawdown (최대 낙폭)**
- 최고점 대비 최대 하락률
- 레버리지 ETF 특성상 -20% ~ -30% 감내 필요
- 목표: -15% 이내 (이상적)

**Win Rate (승률)**
- 전체 거래 중 수익 거래 비율
- 목표: 60% 이상
- 이 전략은 보통 65~75% 승률

**Profit Factor (손익비)**
- 총 수익 / 총 손실
- 해석:
  - < 1.0: 손실
  - 1.0 ~ 1.5: 보통
  - \> 2.0: 매우 좋음

### 백테스트 결과 예시 분석

```
[ 백테스트 결과 ]
  총 수익률:         32.46%      ← 좋음! (연 30%+ 목표 달성)
  샤프 비율:         1.85        ← 좋음! (1.5 이상)
  소르티노 비율:     2.12        ← 매우 좋음! (하방 리스크 잘 관리)
  최대 낙폭:         -12.34%     ← 우수! (레버리지 대비 낮음)
  승률:              68.5%       ← 좋음! (65% 이상)
  손익비:            2.15        ← 매우 좋음!

해석:
✅ 안정적인 수익 창출
✅ 리스크 대비 수익성 우수
✅ 하락 리스크 잘 통제됨
✅ 일관된 수익 패턴

→ 이 파라미터로 실전 운용 가능!
```

```
[ 백테스트 결과 ]
  총 수익률:         45.80%      ← 높음! 하지만...
  샤프 비율:         0.85        ← 낮음 (1.0 미만)
  최대 낙폭:         -28.50%     ← 너무 큼!
  승률:              55.2%       ← 낮음

해석:
⚠️ 수익률은 높지만 변동성이 너무 큼
⚠️ 리스크 대비 수익성 낮음
⚠️ 큰 하락 위험

→ 파라미터 조정 필요:
  - max_positions 줄이기
  - depth_threshold 높이기 (스케일링 속도 늦추기)
  - profit_target 낮추기 (빠른 익절)
```

---

## ⚠️ 주의사항

### 백테스트의 한계

1. **과거 성과 ≠ 미래 수익**
   - 백테스트는 과거 데이터 기반
   - 미래 시장 환경은 다를 수 있음

2. **슬리피지 (Slippage)**
   - 백테스트: 종가에 정확히 체결
   - 실전: 호가 차이, 체결 지연 존재

3. **수수료**
   - 백테스트에서 고려하지만 실제와 다를 수 있음
   - 빈번한 거래 시 수수료 누적 주의

4. **유동성**
   - 백테스트: 원하는 수량 항상 체결
   - 실전: 큰 수량 체결 시 가격 영향 가능

### 레버리지 ETF 리스크

1. **변동성 감소 (Volatility Decay)**
   - 레버리지 ETF는 장기 보유 시 손실 위험
   - 이 전략은 회전율이 높아 영향 완화

2. **리밸런싱 비용**
   - 매일 레버리지 비율 조정
   - 변동성 장세에서 추가 비용 발생

3. **극단적 시장 상황**
   - 서킷브레이커, 급락장 등에서 예상치 못한 손실 가능
   - 반드시 손절 규칙 설정 필요

### 실전 운용 시 주의사항

1. **소액으로 시작**
   ```python
   # 처음에는 작은 자금으로 테스트
   initial_capital = 1000  # $1,000부터 시작
   base_quantity = 1       # 1주씩만
   ```

2. **정기적인 모니터링**
   - 최소 주 1회 포트폴리오 점검
   - 비정상적인 손실 발생 시 즉시 대응

3. **시장 뉴스 체크**
   - 연준 금리 결정, 경제 지표 발표 등 주요 이벤트
   - 극단적 변동성 예상 시 전략 중단 고려

4. **파라미터 고정**
   - 백테스트로 검증된 파라미터 사용
   - 감정적으로 설정 변경 금지
   - 조정 필요 시: 충분한 분석 후 변경

---

## 🎓 추가 학습 자료

### 관련 파일

- **전략 구현**: `src/strategies/percentage_strategy.py` (415~596줄)
- **백테스트 예제**: `examples/daily_accumulation_test.py`
- **백테스트 엔진**: `src/backtesting/backtester.py`

### 추천 실습 순서

1. **기본 백테스트 실행**
   ```bash
   cd examples
   python daily_accumulation_test.py
   ```

2. **파라미터 조정 테스트**
   - profit_target 변경: 2%, 3%, 5%
   - depth_threshold 변경: 3%, 5%, 10%
   - 결과 비교 분석

3. **다른 ETF 테스트**
   - TQQQ, SOXL, UPRO 각각 실행
   - 종목별 최적 파라미터 탐색

4. **커스텀 백테스트 작성**
   - 나만의 시나리오 작성
   - 특정 기간 집중 분석

5. **실전 모의 투자**
   - 종이 거래 (Paper Trading)로 실시간 테스트
   - 최소 1개월 검증 후 실제 투자 고려

### FAQ

**Q: 얼마의 자금이 필요한가요?**
A: 최소 $1,000 권장. 보수적 설정으로 시작하면 충분합니다.

**Q: 어떤 종목이 가장 좋나요?**
A: TQQQ가 가장 인기 있고 변동성도 적절합니다. SOXL은 더 공격적입니다.

**Q: 수수료가 많이 나오지 않나요?**
A: 빈번한 거래로 수수료가 발생하지만, 보통 수익의 5% 미만입니다.

**Q: 언제 손절해야 하나요?**
A: 백테스트 최대 낙폭의 1.5배를 권장합니다. 예: 백테스트 -15% → 실전 -22.5%

**Q: 상승장에서도 작동하나요?**
A: 네! 트레일링 매수 기능으로 상승 중 조정 구간에서도 진입합니다.

**Q: 스케일링을 꼭 써야 하나요?**
A: 아니요. 하지만 스케일링을 사용하면 평균 단가 개선이 훨씬 빠릅니다.

---

## 📞 지원 및 문의

- **이슈 리포트**: GitHub Issues
- **문서**: README.md, DATABASE_GUIDE.md
- **예제 코드**: `examples/` 디렉토리

---

**⚠️ 면책 조항**

본 가이드는 교육 및 정보 제공 목적으로만 작성되었습니다.
- 투자 권유가 아니며, 투자 결정은 본인의 책임입니다
- 레버리지 ETF는 고위험 상품으로 원금 손실 가능성이 있습니다
- 실제 투자 전 반드시 전문가와 상담하시기 바랍니다

**Happy Trading! 📈**
